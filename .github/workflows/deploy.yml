# .github/workflows/deploy.yml
# ê¸°ì¡´ ì½”ë“œ. GitHub Actionsê°€ Deployë˜ì—ˆì§€ë§Œ EC2ì—ì„œ .git íŒŒì¼ì´ ì—†ì–´ pullì„ ëª»ë°›ì•„ ìµœì‹  ì½”ë“œë¥¼ ë°˜ì˜í•˜ì§€ ëª»í•˜ëŠ” ìƒí™©. ì•„ëž˜ì™€ ê°™ì´ ìˆ˜ì •
# name: Deploy to EC2

# on:
#   push:
#     branches: [ main ]  # ë˜ëŠ” ë‚˜ì˜ ë©”ì¸ ë¸Œëžœì¹˜ ì´ë¦„

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v3

#     - name: Set up SSH key
#       run: |
#         mkdir -p ~/.ssh
#         echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
#         chmod 600 ~/.ssh/id_rsa
#         ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

#     - name: Deploy to EC2
#       run: |
#         ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
#           cd ~/  # ë˜ëŠ” Dockerfileì´ ìžˆëŠ” ë””ë ‰í† ë¦¬
#           git pull origin main  # EC2 ì„œë²„ì— ì½”ë“œê°€ clone ë˜ì–´ ìžˆì–´ì•¼ í•¨
#           sudo docker stop yeoyu-container || true
#           sudo docker rm yeoyu-container || true
#           sudo docker build -t yeoyu-backend .
#           sudo docker run -d -p 8080:8080 --name yeoyu-container yeoyu-backend
#         EOF

name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ì €ìž¥ì†Œ Checkout
        uses: actions/checkout@v3

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: Gradle í´ë¦° ë° ë¹Œë“œ
        run: |
          echo "âœ… Gradle ë¹Œë“œ ì‹œìž‘"
          ./gradlew clean
          ./gradlew build
          echo "âœ… Gradle ë¹Œë“œ ì™„ë£Œ"
          echo "ðŸ“ ìƒì„±ëœ íŒŒì¼ í™•ì¸"
          ls -alh build/libs

      - name: EC2 SSH Key ì„¤ì •
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      - name: EC2ì— JAR, Dockerfile ì „ì†¡
        run: |
          echo "ðŸ“¦ JAR íŒŒì¼ ì „ì†¡ ì‹œìž‘"
          scp -o StrictHostKeyChecking=no build/libs/yeoyu-seat-be-0.0.1-SNAPSHOT.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app.jar
          echo "ðŸ“¦ JAR ì „ì†¡ ì™„ë£Œ"
          echo "ðŸ³ Dockerfile ì „ì†¡ ì‹œìž‘"
          scp -o StrictHostKeyChecking=no Dockerfile ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/Dockerfile
          echo "ðŸ³ Dockerfile ì „ì†¡ ì™„ë£Œ"

      - name: EC2ì—ì„œ Docker ë¹Œë“œ ë° ì‹¤í–‰
        run: |
          echo "ðŸ–¥ï¸ EC2ì—ì„œ Docker ë¹Œë“œ ë° ì‹¤í–‰ ì‹œìž‘"
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ"
            sudo docker stop yeoyu-container || true
            sudo docker rm yeoyu-container || true

            echo "ðŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œìž‘"
            sudo docker build -t yeoyu-backend -f Dockerfile .
            echo "ðŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

            echo "ðŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            sudo docker run -d -p 8080:8080 --name yeoyu-container yeoyu-backend
            echo "ðŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          EOF

