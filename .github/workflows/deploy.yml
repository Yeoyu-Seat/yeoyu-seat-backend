name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ Checkout
        uses: actions/checkout@v3

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: Gradle í´ë¦° ë° ë¹Œë“œ
        run: |
          echo "âœ… Gradle ë¹Œë“œ ì‹œì‘"
          ./gradlew clean
          ./gradlew build
          echo "âœ… Gradle ë¹Œë“œ ì™„ë£Œ"
          echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ í™•ì¸"
          ls -alh build/libs

      - name: EC2 SSH Key ì„¤ì •
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      - name: EC2 app.jar ë””ë ‰í† ë¦¬ ì‚­ì œ
        run: |
          echo "ğŸ§¹ EC2ì˜ app.jar ë””ë ‰í† ë¦¬ ì‚­ì œ"
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "rm -rf ~/app.jar"

      - name: EC2ì— JAR, Dockerfile ì „ì†¡
        run: |
          echo "ğŸ“¦ JAR íŒŒì¼ ì „ì†¡ ì‹œì‘"
          scp -o StrictHostKeyChecking=no build/libs/yeoyu-seat-be-0.0.1-SNAPSHOT.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app.jar
          echo "ğŸ“¦ JAR ì „ì†¡ ì™„ë£Œ"
          echo "ğŸ³ Dockerfile ì „ì†¡ ì‹œì‘"
          scp -o StrictHostKeyChecking=no Dockerfile ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/Dockerfile
          echo "ğŸ³ Dockerfile ì „ì†¡ ì™„ë£Œ"

      - name: EC2ì—ì„œ Docker ë¹Œë“œ ë° ì‹¤í–‰
        run: |
          echo "ğŸ–¥ï¸ EC2ì—ì„œ Docker ë¹Œë“œ ë° ì‹¤í–‰ ì‹œì‘"
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ"
            sudo docker stop yeoyu-container || true
            sudo docker rm yeoyu-container || true

            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
            sudo docker build -t yeoyu-backend --build-arg ACTIVE_PROFILE=prod -f Dockerfile .
            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

            echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            sudo docker run -d -p 8080:8080 --name yeoyu-container \
              -e DB_HOST=${{ secrets.RDS_HOST }} \
              -e DB_PORT=${{ secrets.RDS_PORT }} \
              -e DB_NAME=${{ secrets.RDS_DB_NAME }} \
              -e DB_USER=${{ secrets.RDS_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.RDS_PASSWORD }} \
              -e SPRING_PROFILES_ACTIVE=prod \
              yeoyu-backend
            echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          EOF


